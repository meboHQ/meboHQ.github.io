<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/Handlers/Cli.js | Mebo</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-style.css">
<link rel="icon" type="image/png" sizes="64x64" href="data/icon.png?v=1"><script async defer src="https://buttons.github.io/buttons.js"></script></head>
<body class="layout-container" data-ice="rootContainer">

<header><a href="./index.html"><img src="data/icon.png?v=1" id="meboSmallLogo" width="40" height="40" align="top"/></a>
  <a href="./">Home</a>
  <a href="./manual/overview/INTRODUCTION.html" data-ice="manualHeaderLink">Intro</a>
  
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/meboHQ/mebo" class="repo-url-github">Mebo&nbsp;GitHub</a>
  <div class="search-box">
  <span>
    <img src="data/docs/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Action.js~Action.html">Action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handler.js~Handler.html">Handler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboError.js~MeboError.html">MeboError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Metadata.js~Metadata.html">Metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Reader.js~Reader.html">Reader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Tasks.js~Tasks.html">Tasks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writer.js~Writer.html">Writer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Handlers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handlers/Cli.js~Cli.html">Cli</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handlers/Web.js~Web.html">Web</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Inputs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Any.js~Any.html">Any</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/BaseText.js~BaseText.html">BaseText</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Bool.js~Bool.html">Bool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Buf.js~Buf.html">Buf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Email.js~Email.html">Email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/FilePath.js~FilePath.html">FilePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Hash.js~Hash.html">Hash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Hex.js~Hex.html">Hex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Ip.js~Ip.html">Ip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Numeric.js~Numeric.html">Numeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Stream.js~Stream.html">Stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Text.js~Text.html">Text</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Timestamp.js~Timestamp.html">Timestamp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/UUID.js~UUID.html">UUID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Url.js~Url.html">Url</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Version.js~Version.html">Version</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">MeboErrors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboErrors/Conflict.js~Conflict.html">Conflict</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboErrors/Help.js~Help.html">Help</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboErrors/NoContent.js~NoContent.html">NoContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboErrors/NotFound.js~NotFound.html">NotFound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MeboErrors/ValidationFail.js~ValidationFail.html">ValidationFail</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Readers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Readers/CliArgs.js~CliArgs.html">CliArgs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Readers/WebRequest.js~WebRequest.html">WebRequest</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Utils/ImmutableMap.js~ImmutableMap.html">ImmutableMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Utils/LruCache.js~LruCache.html">LruCache</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Writers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writers/CliOutput.js~CliOutput.html">CliOutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writers/WebResponse.js~WebResponse.html">WebResponse</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Handlers/Cli.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const stream = require(&apos;stream&apos;);
const path = require(&apos;path&apos;);
const assert = require(&apos;assert&apos;);
const ejs = require(&apos;ejs&apos;);
const TypeCheck = require(&apos;js-typecheck&apos;);
const Settings = require(&apos;../Settings&apos;);
const Input = require(&apos;../Input&apos;);
const Metadata = require(&apos;../Metadata&apos;);
const Handler = require(&apos;../Handler&apos;);
const MeboErrors = require(&apos;../MeboErrors&apos;);

// symbols used for private members to avoid any potential clashing
// caused by re-implementations
const _args = Symbol(&apos;args&apos;);
const _stdout = Symbol(&apos;stdout&apos;);
const _stderr = Symbol(&apos;stderr&apos;);
const _commands = Symbol(&apos;commands&apos;);

// handler name (used for registration)
const _handlerName = &apos;cli&apos;;


/**
* Handles the command-line integration based on docopt specification.
*
* It enables the execution of actions triggered as command-line
* applications. The args are parsed using the reader {@link CliArgs} and
* the output is provided by writer {@link CliOutput}.
*
* Using cli handler:
*
* **Creating an action that can be executed through command-line**
* ```
* @Mebo.grant(&apos;cli&apos;)
* @Mebo.register(&apos;myAction&apos;)
* class MyAction extends Mebo.Action{
*   constructor(){
*     super();
*     this.setMeta(&apos;description&apos;, &apos;Welcome!&apos;);
*     this.createInput(&apos;myArgument: text&apos;, {elementType: &apos;argument&apos;, description: &apos;my argument&apos;});
*     this.createInput(&apos;myOption: bool&apos;, {description: &apos;my option&apos;});
*   }
*
*   async _perform(data){
*     const result = {
*       myArgument: data.myArgument,
*       myOption: data.myOption,
*     };
*     return result;
*   }
* }
*
* ```
*
* The command-line support can be invoked in two ways:
*
* **1) Multiple commands (recommended):** Used to provide multiple granted actions through command-line
* ```
* if (require.main === module) {
*   const cli = Mebo.Handler.get(&apos;cli&apos;);
*   if (cli.isSupported()){
*     cli.init();
*   }
* }
* ```
* When this method is used the command-line help (`-h` or `--help`)
* provides a list of commands:
*
* ```
* node mycli.js --help
*  __  __      _
* |  \/  | ___| |__   ___
* | |\/| |/ _ \ &apos;_ \ / _ \_
* | |  | |  __/ |_) | (_) |
* |_|  |_|\___|_.__/ \___/
*
* Available commands:
*     myAction
* ```
*
* In order to access the help for each command you need to provide
* the command name before the help flag (`-h` or `--help`)
* ```
* node . myAction --help
* Welcome.
*
* Usage: node mycli.js myAction [options] &lt;my-argument&gt;
*
* Arguments:
*   my-argument     my argument (text type).
*
* Options:
*   --my-option     my option (bool type).
* ```
*
* A complete example about providing multiple commands through command-line
* can be found at: https://github.com/meboHQ/example-cli
*
* **2) Single command:** Used to provide just a single granted action
* through command-line
*
* ```
* if (require.main === module) {
*   // creating an cli handler which is used to load the arguments
*   // arguments to the action and to output the result back to the stream
*   const cli = Mebo.Handler.create(&apos;cli&apos;);
*
*   // loading the parsed information to the action
*   cli.runAction(&apos;myAction&apos;).then((result) =&gt; {
*
*   // success output
*   cli.output(result);
*
*   // error output
*   }).catch((err) =&gt; {
*     cli.output(err);
*   });
* }
* ```
*
* When using the single command the help flag (`-h` or `--help`)
* provides the help about the command directly:
* ```
* node mycli.js --help
* Welcome.
*
* Usage: node mycli.js [options] &lt;my-argument&gt;
*
* Arguments:
*   my-argument     my argument (text type).
*
* Options:
*   --my-option     my option (bool type).
* ```
*
* @see http://docopt.org
*/
class Cli extends Handler{

  /**
   * Creates an cli handler
   *
   * @param {Array&lt;string&gt;} argv - argument list
   * @param {stream} stdout - stream used as stdout
   * @param {stream} stderr - stream used as stderr
   */
  constructor(argv=process.argv, stdout=process.stdout, stderr=process.stderr){
    super();

    this.setArgs(argv);
    this.setStdout(stdout);
    this.setStderr(stderr);
  }

  /**
   * Sets a list of argument values used by the reader. It must follow
   * the same pattern found at `process.argv`
   *
   * @param {Array&lt;string&gt;} value - argument list
   */
  setArgs(value){
    assert(TypeCheck.isList(value), &apos;value needs to be a list&apos;);
    assert(value.length &gt;= 2, &apos;missing first argument process.execPath and second argument javaScript file being executed&apos;);

    this[_args] = value.slice(0);
  }

  /**
   * Returns a list of argument values used by the reader, by default it uses
   * `process.argv`.
   *
   * @return {Array&lt;string&gt;}
   */
  args(){
    return this[_args];
  }

  /**
   * Sets the stdout stream
   *
   * @param {stream} value - stream used as stdout
   */
  setStdout(value){
    assert(value instanceof stream, &apos;Invalid stream type&apos;);

    this[_stdout] = value;
  }

  /**
   * Returns the stream used as stdout
   *
   * @return {stream}
   */
  stdout(){
    return this[_stdout];
  }

  /**
   * Sets the stderr stream
   *
   * @param {stream} value - stream used as stderr
   */
  setStderr(value){
    assert(value instanceof stream, &apos;Invalid stream type&apos;);

    this[_stderr] = value;
  }

  /**
   * Returns the stream used as stderr
   *
   * @return {stream}
   */
  stderr(){
    return this[_stderr];
  }

  /**
   * Returns a boolean telling if cli support can be initialized based on the input argv.
   *
   * @param {Array&lt;string&gt;} [argv] - custom list of arguments, if not specified
   * it uses the `process.argv` (this information is passed to the creation of cli handler)
   * @return {boolean}
   */
  static isSupported(argv=process.argv){
    // checks if there is a command being passed and if the file being
    // executed by node is not inside of a dependency (for instance, mocha
    // contains its own set of command-line args)
    // Also, when argv is passed using process.argv (default) we don&apos;t need to
    // worry about filtering out specific args related with node itself. Since,
    // those args are handled through process.execArgv
    return (argv.length &gt;= 3 &amp;&amp; !path.normalize(argv[1]).split(path.sep).includes(&apos;node_modules&apos;));
  }

  /**
   * Initializes a registered action as cli.
   *
   * *`CliActions/Default.js`: defining an action as cli:*
   * ```
   * const Mebo = require(&apos;mebo&apos;);
   *
   * @Mebo.grant(&apos;cli&apos;, &apos;cli.default&apos;, {command: &apos;default&apos;})
   * @Mebo.register(&apos;cli.default&apos;)
   * class Default extends Mebo.Action{
   *
   *  constructor(){
   *   super();
   *     this.createInput(&apos;name: text&apos;);
   *     this.createInput(&apos;myOtherInput?: numeric&apos;);
   *  }
   *  async _perform(data){
   *    // ...
   *  }
   * }
   *
   * ```
   *
   * *`index.js`:*
   * ```
   * const Mebo = require(&apos;mebo&apos;);
   * require(&apos;Clis/Default.js&apos;);
   *
   * // ...
   * const cli = Mebo.Handler.get(&apos;cli&apos;);
   * if (cli.isSupported()){
   *    cli.init();
   * }
   * ```
   *
   * *Listing available actions:*
   * ```
   * node myFile.js --help
   * ```
   *
   * *Showing help from the app:*
   * ```
   * node myFile.js myCli --help
   * ```
   *
   * *Executing an cli by specifying custom args:*
   * ```
   * node myFile.js myCli --arg-a=1 --arg-b=2
   * ```
   * @param {Object} options - plain object containing custom options
   * @param {Array&lt;string&gt;} [options.argv] - custom list of arguments, if not specified
   * it uses the `process.argv` (this information is passed to the creation of cli handler)
   * @param {stream} [options.stdout] - custom writable stream, if not specified it uses
   * `process.stdout` (this information is passed to the creation of cli handler)
   * @param {stream} [options.stderr] - custom writable stream, if not specified it uses
   * `process.stderr` (this information is passed to the creation of cli handler)
   * @param {function} [options.finalizeCallback] - callback executed after the
   * output. (The value the output value is passed as argument)
   */
  static init(
    {
      argv=process.argv,
      stdout=process.stdout,
      stderr=process.stderr,
      showBanner=true,
      description=&apos;&apos;,
      finalizeCallback=null,
    }={},
  ){
    assert(this.isSupported(argv), &apos;cli support cannot be initialized with the current with input argv&apos;);
    assert(TypeCheck.isString(description), &apos;description needs to be defined as string&apos;);

    const useCommand = argv[2];
    const parsedArgs = argv.slice(0);
    // removing the command name from parsed args
    parsedArgs.splice(2, 1);

    const handler = Handler.create(_handlerName, &apos;*&apos;, parsedArgs, stdout, stderr);

    const _handlerOutput = (output) =&gt; {
      try{
        handler.output(output);
      }
      finally{
        if (finalizeCallback){
          finalizeCallback(output);
        }
      }
    };

    // list the available action names grated for cli
    const availableCommands = this[_commands][_handlerName];
    if ([&apos;-h&apos;, &apos;--help&apos;].includes(useCommand)){

      ejs.renderFile(
        Settings.get(&apos;handler/cli/commandsHelpTemplate&apos;),
        {
          commands: Object.keys(availableCommands),
          showBanner,
          description,
        },
      ).then((result) =&gt; {
        _handlerOutput(new MeboErrors.Help(result));
      }).catch(/* istanbul ignore next */ (error) =&gt; {
        _handlerOutput(error);
      });
    }
    // command not found
    else if (!(useCommand in availableCommands)){
      _handlerOutput(new MeboErrors.Help(`Could not initialize &apos;${useCommand}&apos;, command not found!`));
    }
    // found cli, initializing from it
    else{
      handler.runAction(availableCommands[useCommand].actionName).then((result) =&gt; {
        _handlerOutput(result);
      }).catch(/* istanbul ignore next */ (err) =&gt; {
        _handlerOutput(err);
      });
    }
  }

  /**
   * Return a list of commands mapped to the action name.
   *
   * @param {string} actionName - registered action name
   * @return {Array&lt;string&gt;}
   * @protected
   */
  static actionCommands(actionName){
    assert(TypeCheck.isString(actionName), &apos;actionName needs to be defined as string&apos;);

    const result = [];

    if (_handlerName in this[_commands]){
      for (const name in this[_commands][_handlerName]){
        if (this[_commands][_handlerName][name].actionName === actionName){
          result.push(name);
        }
      }
    }

    return result;
  }

  /**
   * This method can be re-implemented by derived classes to hook when an {@link Action}
   * is granted for a handler ({@link Handler.grantAction})
   *
   * @param {string} handlerName - registered handler name
   * @param {string} actionName - registered action name
   * @param {object} options - custom options passed during {@link Handler.grantAction}
   * @param {string} [options.command] - command name used to initialize the cli, otherwise
   * if not defined the actionName is used instead
   * @protected
   */
  static _grantingAction(handlerName, actionName, {command=null}={}){

    const useCommand = (command || actionName);
    assert(TypeCheck.isString(useCommand), &apos;name needs to be defined as string&apos;);

    if (!(handlerName in this[_commands])){
      this[_commands][handlerName] = {};
    }

    const options = {};
    options.actionName = actionName;

    this[_commands][handlerName][useCommand] = options;
  }

  /**
   * Creates an instance of a reader for the current handler.
   * This passes the {@link Cli.args} to the reader.
   *
   * @param {Action} action - action instance used by the reader to parse the values
   * @param {Object} options - plain object containing the options passed to the reader
   * @return {Reader}
   * @protected
   */
  _createReader(action, options){

    return super._createReader(
      action,
      options,
      this.args(),
    );
  }

  /**
   * Creates an instance of a writer for the current handler
   *
   * This passes the {@link Cli.stdout} and {@link Cli.stderr}
   * to the writer.
   *
   * @param {*} value - arbitrary value passed to the writer
   * @param {Object} options - plain object containing the options passed to the writer
   * @return {Writer}
   * @protected
   */
  _createWriter(value, options){

    return super._createWriter(
      value,
      options,
      this.stdout(),
      this.stderr(),
    );
  }
}

Cli[_commands] = {};

// registering properties
Input.registerProperty(Input, &apos;elementType&apos;, &apos;option&apos;);
Input.registerProperty(Input, &apos;shortOption&apos;);

// registering option vars
Metadata.registerOptionVar(&apos;$cli&apos;, `handler.${_handlerName}`);
Metadata.registerOptionVar(&apos;$cliResult&apos;, &apos;$cli.writeOptions.result&apos;);

// default settings
Settings.set(
  &apos;handler/cli/commandsHelpTemplate&apos;,
  path.join(path.dirname(path.dirname(path.dirname(__filename))), &apos;data&apos;, &apos;handlers&apos;, &apos;cli&apos;, &apos;commandsHelp.ejs&apos;),
);

// registering handler
Handler.register(Cli, _handlerName);

module.exports = Cli;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>

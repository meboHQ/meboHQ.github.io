<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/Writers/WebResponse.js | Mebo</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-style.css">
<link rel="icon" type="image/png" sizes="64x64" href="data/icon.png?v=1"><script async defer src="https://buttons.github.io/buttons.js"></script></head>
<body class="layout-container" data-ice="rootContainer">

<header><a href="./index.html"><img src="data/icon.png?v=1" id="meboSmallLogo" width="40" height="40" align="top"/></a>
  <a href="./">Home</a>
  <a href="./manual/overview/INTRODUCTION.html" data-ice="manualHeaderLink">Intro</a>
  
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/meboHQ/mebo" class="repo-url-github">Mebo&nbsp;GitHub</a>
  <div class="search-box">
  <span>
    <img src="data/docs/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Action.js~Action.html">Action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handler.js~Handler.html">Handler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Metadata.js~Metadata.html">Metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Reader.js~Reader.html">Reader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Tasks.js~Tasks.html">Tasks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writer.js~Writer.html">Writer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Errors/Conflict.js~Conflict.html">Conflict</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Errors/NoContent.js~NoContent.html">NoContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Errors/NotFound.js~NotFound.html">NotFound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Errors/ValidationFail.js~ValidationFail.html">ValidationFail</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Handlers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handlers/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Handlers/Web.js~Web.html">Web</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Inputs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Any.js~Any.html">Any</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/BaseText.js~BaseText.html">BaseText</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Bool.js~Bool.html">Bool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Buf.js~Buf.html">Buf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Email.js~Email.html">Email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/FilePath.js~FilePath.html">FilePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Hash.js~Hash.html">Hash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Hex.js~Hex.html">Hex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Ip.js~Ip.html">Ip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Numeric.js~Numeric.html">Numeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Stream.js~Stream.html">Stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Text.js~Text.html">Text</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Timestamp.js~Timestamp.html">Timestamp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/UUID.js~UUID.html">UUID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Url.js~Url.html">Url</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Inputs/Version.js~Version.html">Version</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Readers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Readers/AppArgs.js~AppArgs.html">AppArgs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Readers/WebRequest.js~WebRequest.html">WebRequest</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Utils/ImmutableMap.js~ImmutableMap.html">ImmutableMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Utils/LruCache.js~LruCache.html">LruCache</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">Writers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writers/AppOutput.js~AppOutput.html">AppOutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Writers/WebResponse.js~WebResponse.html">WebResponse</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Writers/WebResponse.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const assert = require(&apos;assert&apos;);
const stream = require(&apos;stream&apos;);
const TypeCheck = require(&apos;js-typecheck&apos;);
const Settings = require(&apos;../Settings&apos;);
const Handler = require(&apos;../Handler&apos;);
const Writer = require(&apos;../Writer&apos;);

// symbols used for private instance variables to avoid any potential clashing
// caused by re-implementations
const _response = Symbol(&apos;response&apos;);


/**
 * Web output writer.
 *
 * This writer is used by the output of the web handler ({@link Web}).
 *
 * In case the value is an exception then it&apos;s treated as
 * {@link WebResponse._errorOutput} otherwise the value is treated as
 * {@link WebResponse._successOutput}.
 *
 * &lt;h2&gt;Options Summary&lt;/h2&gt;
 *
 * Option Name | Description | Default Value
 * --- | --- | :---:
 * headers | plain object containing the header names (in camel case convention) \
 * that should be used in the response | `{}`
 * headersOnly | if enabled ends the response without any data | <img src="data/docs/value/false.png" title="false">
 * status | success status code (the error status code is driven by the status \
 * defined as a member of the exception) | `200`
 * root | plain object that gets deep merged at the root of the json output\
 * of a success result, for instance:&lt;br&gt;`{data: {...}, &lt;rootContentsA&gt;: ..., \
 * &lt;rootContentsB&gt; : ...}` | `{}`
 * result | Overrides the value returned by {@link Writer.value} to an \
 * arbitrary value (only affects the success output) | <img src="data/docs/value/none.png" title="none">
 * resultLabel | custom label used by the success output when the value is \
 * serialized using json. This label is used to hold the result \
 * under data, for instance:&lt;br&gt;`{data: {&lt;resultLabel&gt;: value}}`&lt;br&gt;&lt;br&gt;In case of \
 * undefined (default) then a fallback label is used based on the value type: \
 * &lt;br&gt;- primitive values are held under &apos;value&apos; \
 * &lt;br&gt;- array value is held under &apos;items&apos; \
 * &lt;br&gt;- object is assigned with &apos;&apos; (empty string) \
 * &lt;br&gt;* when an empty string is used, the value gets merged to the \
 * result.data | <img src="data/docs/value/none.png" title="none">
 *
 * &lt;br&gt;When defining options through the metadata support, it can done using
 * `option vars`. Mebo comes bundled with pre-defined option vars
 * for most of the options available for the readers &amp; writers. The complete list
 * of the option vars can be found at {@link Metadata} documentation.
 *
 * Example of defining the `headers` option from inside of an action through
 * the metadata support:
 *
 * ```
 * // defining &apos;Content-Type&apos; header
 * class MyAction extends Mebo.Action{
 *    _perform(data){
 *
 *      // &apos;Content-Type&apos; header
 *      this.setMeta(&apos;$webHeaders&apos;, {
 *        contentType: &apos;application/octet-stream&apos;,
 *      });
 *
 *      // ...
 *    }
 * }
 * ```
 *
 * Also, headers can be defined through &apos;before action middlewares&apos;
 * ({@link Web.addBeforeAction} and {@link Web.addBeforeAuthAction})
 */
class WebResponse extends Writer{

  /**
   * Creates a web response writer
   *
   * @param {*} value - arbitrary value passed to the writer
   * @param {Object} res - express res object
   */
  constructor(value, res){
    super(value);
    this._setResponse(res);

    // default options
    this.setOption(&apos;headersOnly&apos;, false);
    this.setOption(&apos;headers&apos;, {});
    this.setOption(&apos;root&apos;, {
      apiVersion: Settings.get(&apos;apiVersion&apos;),
    });
    this.setOption(&apos;status&apos;, 200);
  }

  /**
   * Returns the response object created by express
   *
   * @return {Object}
   * @see http://expressjs.com/en/api.html#res
   */
  response(){
    return this[_response];
  }

  /**
   * Implements the response for an error value.
   *
   * Any error can carry a HTTP status code. It is done by defining `status` to any error
   * (for instance ```err.status = 501;```).
   * This practice can be found in all errors shipped with mebo ({@link Conflict}, {@link NoContent},
   * {@link NotFound} and {@link ValidationFail}). In case none status is found in the error then `500`
   * is used automatically.
   *
   * The error response gets automatically encoded using json, following the basics
   * of google&apos;s json style guide. In case of an error status `500` the standard
   * result is ignored and a message `Internal Server Error` is used instead.
   *
   * Further information can be found at base class documentation
   * {@link Writer._errorOutput}.
   *
   * @protected
   */
  _errorOutput(){

    const status = this.value().status || 500;

    // setting the status code for the response
    this.response().status(status);

    const result = {
      error: {
        code: status,
        message: super._errorOutput(),
      },
    };

    // adding the stack-trace information when running in development mode
    /* istanbul ignore next */
    if (process.env.NODE_ENV === &apos;development&apos;){
      result.error.stacktrace = this.value().stack.split(&apos;\n&apos;);
    }

    // should not leak any error message for the status code 500
    if (status === 500){
      result.error.message = &apos;Internal Server Error&apos;;
    }

    this._genericOutput(result);
  }

  /**
   * Implements the response for a success value.
   *
   * A readable stream value is piped using &apos;application/octet-stream&apos; by default
   * (if it has not been defined by the header option &apos;contentType&apos;),
   * otherwise for non-readable stream value it&apos;s automatically encoded
   * using json, following the basics of google&apos;s json style guide.
   *
   * Further information can be found at base class documentation
   * {@link Writer._successOutput}.
   *
   * @see https://google.github.io/styleguide/jsoncstyleguide.xml
   * @protected
   */
  _successOutput(){

    const result = super._successOutput();

    // setting the status code for the response
    this.response().status(this.option(&apos;status&apos;));

    // setting header
    this._setResponseHeaders();

    // readable stream
    if (result instanceof stream.Readable){
      this._successStreamOutput(result);
      return;
    }

    this._successJSONOutput(result);
  }

  /**
   * Sets the response object created by express
   *
   * @param {Object} value - res object
   * @see http://expressjs.com/en/api.html#res
   * @private
   */
  _setResponse(value){
    assert(TypeCheck.isObject(value) &amp;&amp; TypeCheck.isObject(value.locals), &apos;Invalid response object&apos;);

    this[_response] = value;
  }

  /**
   * Results a stream through the success output
   *
   * @param {stream} value - output value
   * @private
   */
  _successStreamOutput(value){
    // setting a default content-type for readable stream in case
    // it has not been set previously
    const headers = this.option(&apos;headers&apos;);
    if (!(headers &amp;&amp; headers.contentType)){
      this.response().setHeader(&apos;Content-Type&apos;, &apos;application/octet-stream&apos;);
    }

    value.pipe(this.response());
  }

  /**
   * Results the default success output through google&apos;s json style guide
   *
   * @param {*} result - output value
   * @private
   */
  _successJSONOutput(result){

    const output = {};

    // including the root options
    Object.assign(output, this.option(&apos;root&apos;));

    // automatic result, it is done by figuring out the response based on
    // the value returned by the action, otherwise if output contains data
    // returns that instead
    output.data = {};

    if (result !== undefined){

      // in case the value has defined &apos;toJSON&apos; calling that to get result
      // value that should be used for the output, reference:
      // https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify
      let finalResult = result;
      if (TypeCheck.isCallable(result.toJSON)){
        finalResult = JSON.parse(JSON.stringify(result));
      }

      // resolving the result label
      const resultLabel = this._resultLabel(finalResult);

      if (resultLabel){
        output.data[resultLabel] = finalResult;
      }
      else{
        assert(!TypeCheck.isPrimitive(finalResult), &quot;Can&apos;t output a primitive value without a &apos;resultLabel&apos;&quot;);
        assert(TypeCheck.isPlainObject(finalResult), &quot;Can&apos;t output a non-plain object value&quot;);
        output.data = finalResult;
      }
    }

    this._genericOutput(output);
  }

  /**
   * Generic output routine shared by both success and error outputs
   *
   * @param {*} output - arbitrary data used as output
   * @private
   */
  _genericOutput(output){

    // ending response without any data
    if (this.option(&apos;headersOnly&apos;)){
      this.response().end();
      return;
    }

    // json output
    this.response().json(output);
  }

  /**
   * Returns the label used to hold the result under data. In case of undefined
   * (default) it uses a fallback label based on the value type:
   *
   * - primitive values are held under &apos;value&apos;
   * - array value is held under &apos;items&apos;
   * - object is assigned with `null`
   * * when an empty string is used, the value gets merged to the result.data
   *
   * @param {*} value - value that should be used by the result entry
   * @return {string}
   * @private
   */
  _resultLabel(value){
    let resultLabel = this.option(&apos;resultLabel&apos;);
    if (resultLabel === undefined){
      if (TypeCheck.isPrimitive(value)){
        resultLabel = &apos;value&apos;;
      }
      else if (TypeCheck.isList(value)){
        resultLabel = &apos;items&apos;;
      }
      else{
        resultLabel = &apos;&apos;;
      }
    }

    return resultLabel;
  }

  /**
   * Looks for any header member defined as part of the options and sets them
   * to the response header. It expects a camelCase name convention for the header name
   *  where it gets translated to the header name convention, for instance:
   * &apos;options.headers.contentType&apos; translates to &apos;Content-Type&apos;.
   *
   * @param {*} options - options passed to the output
   * @private
   */
  _setResponseHeaders(){

    const headers = this.option(&apos;headers&apos;);
    const response = this.response();
    if (headers){
      for (const headerName in headers){
        const convertedHeaderName = headerName.replace(/([a-z])([A-Z])/g, &apos;$1-$2&apos;).toLowerCase();

        // assigning a header value to the response
        response.setHeader(convertedHeaderName, headers[headerName]);
      }
    }
  }
}

// registering writer
Handler.registerWriter(WebResponse, &apos;web&apos;);

module.exports = WebResponse;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
